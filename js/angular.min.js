var app=angular.module("kaifanla",["ionic"]);app.factory("$debounce",["$rootScope","$browser","$q","$exceptionHandler",function(b,a,e,f){var h={},d={},g=0;function c(p,m,n){var r=e.defer(),s=r.promise,k=(angular.isDefined(n)&&!n),q,i,o,j=false;angular.forEach(d,function(u,t){if(angular.equals(d[t].fn,p)){j=true;o=t}});if(!j){o=g++;d[o]={fn:p}}else{h[d[o].timeoutId].reject("bounced");a.defer.cancel(d[o].timeoutId)}var l=function(){delete d[o];try{r.resolve(p())}catch(t){r.reject(t);f(t)}if(!k){b.$apply()}};q=a.defer(l,m);d[o].timeoutId=q;i=function(t){delete h[s.$$timeoutId]};s.$$timeoutId=q;h[q]=r;s.then(i,i);return s}c.cancel=function(i){if(i&&i.$$timeoutId in h){h[i.$$timeoutId].reject("canceled");return a.defer.cancel(i.$$timeoutId)}return false};return c}]);app.config(function(b,a){b.state("start",{url:"/kflstart",templateUrl:"tpl/start.html"}).state("main",{url:"/kflmain",templateUrl:"tpl/main.html",controller:"mainCtrl"}).state("detail",{url:"/kfldetail/:id",templateUrl:"tpl/detail.html",controller:"detailCtrl"}).state("myorder",{url:"/kflmyorder",templateUrl:"tpl/myorder.html",controller:"myorderCtrl"}).state("setting",{url:"/kflsetting",templateUrl:"tpl/settings.html",controller:"settingCtrl"}).state("cart",{url:"/kflcart",templateUrl:"tpl/cart.html",controller:"cartCtrl"}).state("register",{url:"/kflregister",templateUrl:"tpl/register.html",controller:"registerCtrl"}).state("success",{url:"/kflsuccess/:oid",templateUrl:"tpl/include/success.html",controller:"successCtrl"});a.otherwise("/kflstart")});app.run(function(a){a.defaults.headers.post={"Content-Type":"application/x-www-form-urlencoded"}});app.controller("mainCtrl",["$scope","$http","$debounce","$ionicLoading","$timeout",function(a,e,d,c,b){a.hasMore=true;a.shwo=false;e.get("data/dish_getbypage.php?start="+0).success(function(f){a.list=f;console.log(a.list)});a.parent={search:""};a.$watch("parent.search",function(){d(watchSearch,300)});watchSearch=function(){console.log("搜索打印："+a.parent.search);if(a.parent.search){e({method:"post",url:"data/dish_getbykw.php?search="+a.parent.search}).success(function(f){a.list=f;if(a.list.length<1){a.shwo=true}else{if(a.list.length>0){a.shwo=false}else{if(a.list.code==-1){console.log(a.list.msg)}}}console.log(a.list)})}else{e.get("data/dish_getbypage.php?start="+0).success(function(f){a.list=f})}};a.btn=function(){e.get("data/dish_getbypage.php?start="+a.list.length).success(function(f){if(f.length<5){a.hasMore=false}a.list=a.list.concat(f);a.shwo=false;console.log(a.list)})};a.loadMore=function(){e.get("data/dish_getbypage.php?start="+a.list.length).success(function(f){if(f.length<5){a.hasMore=false}a.list=a.list.concat(f);a.$broadcast("scroll.infiniteScrollComplete");a.shwo=false;console.log(a.list)})}}]);app.controller("detailCtrl",["$scope","$stateParams","$http","$ionicPopup",function(b,c,e,d){var a=sessionStorage.userid;console.log("获取商品id："+c.id);e.get("data/dish_getbyid.php?id="+c.id).success(function(f){console.log(f[0]);b.list=f[0]});b.add_order=function(){console.log(a);if(a===undefined){$state.go("register")}var f="did="+b.list.did+"&uid="+a+"&count=-1";console.log(f);e.post("data/cart_update.php",f).success(function(g){console.log(g);b.data.totalNumInCart++;d.alert({title:"购物车弹出框",template:"确认添加成功"})})}}]);app.controller("myorderCtrl",["$scope","$http","$state",function(b,d,c){var a=sessionStorage.userid;if(a===undefined){console.log(a);c.go("register")}else{d.get("data/order_getbyuserid.php?userid="+a).success(function(e){console.log(e);b.list=e.data;if(b.list.length<1){b.res="无订单去主页购买"}})}}]);app.controller("cartCtrl",["$scope","$http","$ionicModal","$httpParamSerializerJQLike","$ionicLoading","$state",function(c,g,b,e,f,d){var a=sessionStorage.userid;g.get("data/cart_select.php?uid="+a).success(function(i){c.list=i.data;updateTotaNum=function(){c.data.totalNumInCart=0;angular.forEach(c.list,function(l,k){c.data.totalNumInCart+=parseInt(l.dishCount)})};console.log(c.list);updateTotaNum();if(c.list.length<1){c.cart_ts="购物车无商品！"}c.sumAll=function(){var k=0;angular.forEach(c.list,function(m,l){k+=(m.price*m.dishCount)});return k};var j=0;angular.forEach(angular.fromJson(c.list),function(l,k){j+=(l.price*l.dishCount)});var h=angular.toJson(c.list);c.order={cartDetail:h,totalprice:j,userid:a};c.Submit_btn=function(){var k=e(c.order);g.post("data/order_add.php",k).success(function(l){console.log(l);c.modal.hide();updateTotaNum();d.go("myorder")})};c.delete_btn=function(k,l){console.log(k,l);updateTotaNum();g.post("data/cart_update.php?uid="+a+"&count=-2&did="+c.list[k].did).success(function(m){console.log(m);f.show({template:"成功删除...",duration:500});c.list.splice(k,1)})};c.add_btn=function(k){console.log(k);c.list[k].dishCount++;g.post("data/cart_update.php?uid="+a+"&count="+c.list[k].dishCount+"&did="+c.list[k].did).success(function(l){console.log(l);updateTotaNum()})};c.minus=function(k){console.log(k);c.list[k].dishCount--;if(c.list[k].dishCount==0){c.list[k].dishCount=1}else{g.post("data/cart_update.php?uid="+a+"&count="+c.list[k].dishCount+"&did="+c.list[k].did).success(function(l){console.log(l);updateTotaNum()})}};b.fromTemplateUrl("cart_btn.html",{scope:c}).then(function(k){c.modal=k});c.open=function(){if(c.list.length<1){f.show({template:"购物车无商品！",duration:1000})}else{c.modal.show()}};c.close=function(){c.modal.hide()}})}]);app.controller("settingCtrl",["$scope","$http","$ionicModal","$state",function(c,e,b,d){var a=sessionStorage.userid;if(a===undefined){d.go("register")}e.get("data/About.php?userid="+a).success(function(f){console.log(f);c.list=f});b.fromTemplateUrl("useropen.html",{scope:c}).then(function(f){c.modal2=f});c.useropen=function(){c.modal2.show()};c.close2=function(){c.modal2.hide()};b.fromTemplateUrl("About.html",{scope:c}).then(function(f){c.modal=f});c.open=function(){c.modal.show()};c.close=function(){c.modal.hide()};c.closeout=function(){sessionStorage.removeItem("userid");d.go("start")}}]);app.controller("registerCtrl",["$scope","$http","$httpParamSerializerJQLike","$ionicLoading","$timeout","$state",function(a,f,d,e,c,b){e.show({template:"请注册用户...",duration:1000});a.data={};a.register_btn=function(){var g=d(a.data);console.log(g);f.post("data/register.php",g).success(function(h){console.log(h);sessionStorage.setItem("userid",h);e.show({template:"注册成功并登陆...",duration:1000});c(function(){b.go("myorder")},1000)})}}]);app.controller("successCtrl",["$scope","$stateParams",function(a,b){console.log("获取商品id："+b.oid);a.list=b.oid}]);app.controller("parentCtrl",["$scope","$state",function(a,b){a.data={totalNumInCart:0};a.jump=function(c,d){console.log(c,d);b.go(c)}}]);